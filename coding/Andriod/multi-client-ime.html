
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Multi Client Ime · Kent的博客</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-toggle-chapters/toggle.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-page-treeview/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sidebar-style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-auto-scroll-table/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-click-reveal/click_reveal.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-accordion/accordion.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="permissions.html" />
    
    
    <link rel="prev" href="InputMethod.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../">
            
                <a href="../">
            
                    
                    Coding
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="./">
            
                <a href="./">
            
                    
                    Andriod
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="AMS_.html">
            
                <a href="AMS_.html">
            
                    
                    AMS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="AndriodIPC.html">
            
                <a href="AndriodIPC.html">
            
                    
                    Andriod IPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="AndriodSystem.html">
            
                <a href="AndriodSystem.html">
            
                    
                    Andriod System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.4" data-path="ANR_crash.html">
            
                <a href="ANR_crash.html">
            
                    
                    ANR Crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.5" data-path="APK_64bit_32bit.html">
            
                <a href="APK_64bit_32bit.html">
            
                    
                    APK 64 Bit 32 Bit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6" data-path="DesignPattern.html">
            
                <a href="DesignPattern.html">
            
                    
                    Design Pattern
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.7" data-path="Graphic.html">
            
                <a href="Graphic.html">
            
                    
                    Graphic
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.8" data-path="HowToReadCode.html">
            
                <a href="HowToReadCode.html">
            
                    
                    How To Read Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.9" data-path="HowWritecode.html">
            
                <a href="HowWritecode.html">
            
                    
                    How Writecode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.10" data-path="InitSystem.html">
            
                <a href="InitSystem.html">
            
                    
                    Init System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.11" data-path="Input.html">
            
                <a href="Input.html">
            
                    
                    Input
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.12" data-path="InputMethod.html">
            
                <a href="InputMethod.html">
            
                    
                    Input Method
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.1.13" data-path="multi-client-ime.html">
            
                <a href="multi-client-ime.html">
            
                    
                    Multi Client Ime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.14" data-path="permissions.html">
            
                <a href="permissions.html">
            
                    
                    Permissions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.15" data-path="refactor.html">
            
                <a href="refactor.html">
            
                    
                    Refactor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.16" data-path="startAPP.html">
            
                <a href="startAPP.html">
            
                    
                    Start APP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.17" data-path="Systrace.html">
            
                <a href="Systrace.html">
            
                    
                    Systrace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.18" data-path="wms_animination.html">
            
                <a href="wms_animination.html">
            
                    
                    Wms Animination
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.19" data-path="WMS.html">
            
                <a href="WMS.html">
            
                    
                    WMS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.20" data-path="无障碍_.html">
            
                <a href="无障碍_.html">
            
                    
                    无障碍_
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.21" data-path="稳定性_性能问题.html">
            
                <a href="稳定性_性能问题.html">
            
                    
                    稳定性_性能问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../CodingLanguage/">
            
                <a href="../CodingLanguage/">
            
                    
                    Coding Language
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../CodingLanguage/c_cpp_java.html">
            
                <a href="../CodingLanguage/c_cpp_java.html">
            
                    
                    C Cpp Java
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="../CodingLanguage/R.html">
            
                <a href="../CodingLanguage/R.html">
            
                    
                    R
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../computorBase/">
            
                <a href="../computorBase/">
            
                    
                    Computor Base
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="../computorBase/linux.html">
            
                <a href="../computorBase/linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="../computorBase/OperateSysTem.html">
            
                <a href="../computorBase/OperateSysTem.html">
            
                    
                    Operate Sys Tem
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Tool/">
            
                <a href="../Tool/">
            
                    
                    Tool
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../Tool/aospBuilding.html">
            
                <a href="../Tool/aospBuilding.html">
            
                    
                    Aosp Building
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../Tool/AS.html">
            
                <a href="../Tool/AS.html">
            
                    
                    AS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.3" data-path="../Tool/clion.html">
            
                <a href="../Tool/clion.html">
            
                    
                    Clion
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.4" data-path="../Tool/command.html">
            
                <a href="../Tool/command.html">
            
                    
                    Command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.5" data-path="../Tool/debugSkills.html">
            
                <a href="../Tool/debugSkills.html">
            
                    
                    Debug Skills
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.6" data-path="../Tool/Docker.html">
            
                <a href="../Tool/Docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.7" data-path="../Tool/git.html">
            
                <a href="../Tool/git.html">
            
                    
                    Git
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.8" data-path="../Tool/phoneCommand.html">
            
                <a href="../Tool/phoneCommand.html">
            
                    
                    Phone Command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.9" data-path="../Tool/software_pcSettings.html">
            
                <a href="../Tool/software_pcSettings.html">
            
                    
                    Software Pc Settings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.10" data-path="../Tool/sourceInsight.html">
            
                <a href="../Tool/sourceInsight.html">
            
                    
                    Source Insight
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.11" data-path="../Tool/tmux_linux.html">
            
                <a href="../Tool/tmux_linux.html">
            
                    
                    Tmux Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.12" data-path="../Tool/virtualStudioCode.html">
            
                <a href="../Tool/virtualStudioCode.html">
            
                    
                    Virtual Studio Code
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../English/English.html">
            
                <a href="../../English/English.html">
            
                    
                    English
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../Investment/Investment.html">
            
                <a href="../../Investment/Investment.html">
            
                    
                    Investment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../Naturalaw/">
            
                <a href="../../Naturalaw/">
            
                    
                    Naturalaw
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../Naturalaw/ReadingAndThinking.html">
            
                <a href="../../Naturalaw/ReadingAndThinking.html">
            
                    
                    Reading And Thinking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../../Naturalaw/修.html">
            
                <a href="../../Naturalaw/修.html">
            
                    
                    修
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../Scriptures/">
            
                <a href="../../Scriptures/">
            
                    
                    Scriptures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../../Scriptures/金刚经.html">
            
                <a href="../../Scriptures/金刚经.html">
            
                    
                    金刚经
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../../CheckList.html">
            
                <a href="../../CheckList.html">
            
                    
                    Check List
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Multi Client Ime</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#multi-client-input-method-editors"><b>1. </b>Multi Client Input Method Editors</a></li><ul><li><span class="title-icon "></span><a href="#history-of-multi-client-input-method-editors-multi-client-imes"><b>1.1. </b>History of Multi Client Input Method Editors (Multi Client IMEs)</a></li><li><span class="title-icon "></span><a href="#how-to-test"><b>1.2. </b>How to test</a></li><li><span class="title-icon "></span><a href="#how-to-develop-multi-client-imes"><b>1.3. </b>How to develop multi-client IMEs</a></li><li><span class="title-icon "></span><a href="#versioning"><b>1.4. </b>Versioning</a></li><li><span class="title-icon "></span><a href="#implementation-note"><b>1.5. </b>Implementation note</a></li><ul><li><span class="title-icon "></span><a href="#unsupported-features"><b>1.5.1. </b>Unsupported features</a></li><li><span class="title-icon "></span><a href="#security"><b>1.5.2. </b>Security</a></li></ul></ul></ul></div><a href="#multi-client-input-method-editors" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><div class="treeview__container"><div class="treeview__container-title"><span class="treeview__main-title">Treeview</span><span class="treeview__copyright">Copyright &#xA9; aleen42 all right reserved, powered by <a href="https://github.com/aleen42" target="_blank">aleen42</a></span></div><ul>
<li><div><a href="#multi-client-input-method-editors">Multi Client Input Method Editors</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#history-of-multi-client-input-method-editors-multi-client-imes">History of Multi Client Input Method Editors (Multi Client IMEs)</a><i></i></div></li>
<li><div><a href="#how-to-test">How to test</a><i></i></div></li>
<li><div><a href="#how-to-develop-multi-client-imes">How to develop multi-client IMEs</a><i></i></div></li>
<li><div><a href="#versioning">Versioning</a><i></i></div></li>
<li><div><a href="#implementation-note">Implementation note</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#unsupported-features">Unsupported features</a><i></i></div></li>
<li><div><a href="#security">Security</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#root-permission-is-required-to-enable-mcimms-on-non-supported-devices">Root permission is required to enable MCIMMS on non-supported devices</a><i></i></div></li>
<li><div><a href="#multi-client-ime-must-be-pre-installed">Multi-client IME must be pre-installed</a><i></i></div></li>
<li><div><a href="#integer-handle-vs-ibinder-token">Integer handle vs IBinder token</a><i></i></div></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>

<p>&lt;!-- Copyright (C) 2018 The Android Open Source Project</p>
<pre><code> Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
</code></pre><h1 id="multi-client-input-method-editors"><a name="multi-client-input-method-editors" class="anchor-navigation-ex-anchor" href="#multi-client-input-method-editors"><i class="fa fa-link" aria-hidden="true"></i></a>1. Multi Client Input Method Editors</h1>
<h2 id="history-of-multi-client-input-method-editors-multi-client-imes"><a name="history-of-multi-client-input-method-editors-multi-client-imes" class="anchor-navigation-ex-anchor" href="#history-of-multi-client-input-method-editors-multi-client-imes"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. History of Multi Client Input Method Editors (Multi Client IMEs)</h2>
<p>An advanced multi-display support is requested for certain Android form-factors so that user(s) can type text on each display at the same time without losing software keyboard focus in other displays (hereafter called &quot;multi-client scenario&quot;). This is not possible in Android IMEs built on top of <code>InputMethodService</code> class. The assumption that a single IME client can be focused at the same time was made before Android IME APIs were introduced in Android 1.5 and many public APIs in <code>InputMethodService</code> have already relied heavily on that assumption (hereafter called &quot;single-client scenario&quot;). Updating <code>InputMethodService</code> class to support multi-client scenario is, however, quite challenging because:</p>
<ol>
<li>doing so would introduce an unacceptable amount of complexity into <code>InputMethodService</code>, which is already hard to maintain,</li>
<li>IME developers still need to update their implementation to be able to support parallel requests from multiple focused IME client, which may require non-trivial redesign in their side (e.g. input decoder, typing history database, ...), and</li>
<li>actual use cases for multi IME clients are expected to be evolved rapidly hence the new protocol is not yet stable and not yet ready to be exposed as public APIs.</li>
</ol>
<p>Thus the first decision we made was that to support such special multi-display environments a new type of IME (hereafter called &quot;multi-client IME&quot;) needs to be designed and implemented rather than reusing <code>InputMethodService</code> public class. On top of this decision, following decisions were also made:</p>
<ul>
<li>Multi-client IME V1 will be built on top of private APIs. This means:<ul>
<li>Multi-client IME must be pre-installed into the system. They cannot be distributed via application store since protocol compatibility is not guaranteed across devices and releases.</li>
<li>The system should trust multi-client IME to some extent. System integrators are responsible for making sure that the pre-installed multi-client IME works as expected.</li>
</ul>
</li>
<li>Unlike <code>InputMethodService</code>, multiple multi-client IMEs cannot be enabled. The system pre-installs only one multi-client IME.</li>
<li>Punt some special features of Android IMEs (e.g. fullscreen mode, InputMethodSubtype, ...) from V1 goal unless someone actually requests those features for multi-client IME scenario.</li>
<li>Introduce <code>MultiClientInputMethodManagerService</code> (MCIMMS) for multi-client IME scenario and use it instead of <code>InputMethodManagerService</code> (IMMS) when a certain runtime flag is enabled at the device boot time. This means:<ul>
<li>basically no risk for single-client scenario,</li>
<li>the feature can be easily deprecated, and</li>
<li>it forces us to rewrite IME system server, which is expected to be a good chance to reconsider what Android IME protocol should look like.</li>
</ul>
</li>
<li>Most of form-factors such as Phones and TVs continue to use IMMS and support at most one focused IME client even under multi-display environment.</li>
</ul>
<h2 id="how-to-test"><a name="how-to-test" class="anchor-navigation-ex-anchor" href="#how-to-test"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. How to test</h2>
<p>For multi-client IME to properly work, an internal boolean resource <code>com.android.internal.R.bool.config_perDisplayFocusEnabled</code> needs to be <code>true</code>. Since this value cannot be overridden at the run time, you may need to rebuild the system image to enable per-display focus mode.</p>
<p>As for multi-client IME mode itself, you can enable multi-client IME mode just by setting a valid component name that supports multi-client IME protocol to the system property <code>persist.debug.multi_client_ime</code>, as long as <code>android.os.Build.IS_DEBUGGABLE</code> returns <code>true</code> and you can have root access. Reboot is required for this to take effect.</p>
<pre><code class="lang-shell"># Build and install a sample multi-client IME
make -j MultiClientInputMethod
adb install -r $OUT/system/priv-app/MultiClientInputMethod/MultiClientInputMethod.apk

# Enable multi-client IME for the side-loaded sample multi-client IME
adb root
adb shell setprop persist.debug.multi_client_ime com.example.android.multiclientinputmethod/.MultiClientInputMethod
adb reboot
</code></pre>
<p>To disable multi-client IME on non-supported devices again, just clear <code>persist.debug.multi_client_ime</code> as follows. Reboot is still required for this to take effect.</p>
<pre><code class="lang-shell"># Disable multi-client IME again
adb root
adb shell &quot;setprop persist.debug.multi_client_ime &apos;&apos;&quot;
adb reboot
</code></pre>
<h2 id="how-to-develop-multi-client-imes"><a name="how-to-develop-multi-client-imes" class="anchor-navigation-ex-anchor" href="#how-to-develop-multi-client-imes"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. How to develop multi-client IMEs</h2>
<p>There is a sample multi-client IME in <code>development/samples/MultiClientInputMethod/</code>.</p>
<h2 id="versioning"><a name="versioning" class="anchor-navigation-ex-anchor" href="#versioning"><i class="fa fa-link" aria-hidden="true"></i></a>1.4. Versioning</h2>
<p>Neither forward nor backward compatibility is guaranteed in multi-client IME APIs. The system integrator is responsible for making sure that both the system and pre-installed multi-client IME are compatible with each other every time the system image is updated.</p>
<h2 id="implementation-note"><a name="implementation-note" class="anchor-navigation-ex-anchor" href="#implementation-note"><i class="fa fa-link" aria-hidden="true"></i></a>1.5. Implementation note</h2>
<p>``</p>
<h3 id="unsupported-features"><a name="unsupported-features" class="anchor-navigation-ex-anchor" href="#unsupported-features"><i class="fa fa-link" aria-hidden="true"></i></a>1.5.1. Unsupported features</h3>
<ul>
<li>VR IME<ul>
<li><code>VrManager#setVrInputMethod()</code> system API is not supported.</li>
</ul>
</li>
<li>InputMethodSubtype<ul>
<li>Following APIs are not supported<ul>
<li><code>InputMethodManager#getEnabledInputMethodSubtypeList()</code>    ----&gt; adb shell ime list&#x5931;&#x6548;&#x7684;&#x539F;&#x56E0;&#xFF08;multi-client&#x8F93;&#x5165;&#x6CD5;&#x4E0B;&#xFF09;</li>
<li><code>InputMethodManager#getCurrentInputMethodSubtype()</code></li>
<li><code>InputMethodManager#setCurrentInputMethodSubtype()</code></li>
<li><code>InputMethodManager#getShortcutInputMethodsAndSubtypes()</code></li>
<li><code>InputMethodManager#setAdditionalInputMethodSubtypes()</code></li>
<li><code>InputMethodManager#getLastInputMethodSubtype()</code></li>
<li><code>Settings.Secure#SELECTED_INPUT_METHOD_SUBTYPE</code></li>
</ul>
</li>
</ul>
</li>
<li>IME switching<ul>
<li>Following APIs are not supported<ul>
<li><code>InputMethodManager#showInputMethodPicker()</code></li>
<li><code>InputMethodManager#showInputMethodAndSubtypeEnabler()</code></li>
<li><code>InputMethodManager#setInputMethod()</code></li>
<li><code>InputMethodManager#setInputMethodAndSubtype()</code></li>
<li><code>InputMethodManager#switchToLastInputMethod()</code></li>
<li><code>InputMethodManager#switchToNextInputMethod()</code></li>
<li><code>InputMethodManager#shouldOfferSwitchingToNextInputMethod()</code></li>
<li><code>Settings.Secure#DEFAULT_INPUT_METHOD</code></li>
<li><code>Settings.Secure#ENABLED_INPUT_METHODS</code></li>
</ul>
</li>
</ul>
</li>
<li>Direct-boot aware multi-client IME<ul>
<li>Device manufacturer can work around this by integrating in-app keyboard into the initial unlock screen.</li>
</ul>
</li>
<li>Full-screen mode<ul>
<li>Following API always returns <code>false</code>.<ul>
<li><code>InputMethodManager#isFullscreenMode()</code></li>
</ul>
</li>
</ul>
</li>
<li>Custom inset<ul>
<li>For instance, floating IME cannot be implemented right now.</li>
</ul>
</li>
<li>Custom touchable region (<code>InputMethodService.Insets#touchableRegion</code>)</li>
<li>Image Insertion API<ul>
<li><code>InputConnection#commitContent()</code> API is silently ignored.</li>
</ul>
</li>
<li><code>adb shell dumpsys</code> does not include any log from MCIMMS yet.</li>
</ul>
<h3 id="security"><a name="security" class="anchor-navigation-ex-anchor" href="#security"><i class="fa fa-link" aria-hidden="true"></i></a>1.5.2. Security</h3>
<h4 id="root-permission-is-required-to-enable-mcimms-on-non-supported-devices"><a name="root-permission-is-required-to-enable-mcimms-on-non-supported-devices" class="anchor-navigation-ex-anchor" href="#root-permission-is-required-to-enable-mcimms-on-non-supported-devices"><i class="fa fa-link" aria-hidden="true"></i></a>Root permission is required to enable MCIMMS on non-supported devices</h4>
<p>In order to override <code>persist.debug.multi_client_ime</code> device property, an explicit root permission is needed.</p>
<h4 id="multi-client-ime-must-be-pre-installed"><a name="multi-client-ime-must-be-pre-installed" class="anchor-navigation-ex-anchor" href="#multi-client-ime-must-be-pre-installed"><i class="fa fa-link" aria-hidden="true"></i></a>Multi-client IME must be pre-installed</h4>
<p>Multi-client IME must be pre-installed since it is considered as part of the system component. This is verified by checking <code>ApplicationInfo.FLAG_SYSTEM</code> bit. This security check can be bypassed when <code>Build.IS_DEBUGGABLE</code> is <code>true</code> so that IME developers can easily side-load their APKs during development phase.</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiClientInputMethodManagerService</span> </span>{
    ...
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InputMethodInfo <span class="hljs-title">queryInputMethod</span><span class="hljs-params">(Context context, @UserIdInt <span class="hljs-keyword">int</span> userId,
            @Nullable ComponentName componentName)</span> </span>{

        ...

        <span class="hljs-keyword">if</span> (! &amp;&amp; (si.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="hljs-number">0</span>) {
            Slog.e(TAG, imeId + <span class="hljs-string">&quot; must be pre-installed when Build.IS_DEBUGGABLE is false&quot;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
</code></pre>
<p><a href="MultiClientInputMethodManagerService.java">services/core/java/com/android/server/inputmethod/MultiClientInputMethodManagerService.java</a></p>
<h4 id="integer-handle-vs-ibinder-token"><a name="integer-handle-vs-ibinder-token" class="anchor-navigation-ex-anchor" href="#integer-handle-vs-ibinder-token"><i class="fa fa-link" aria-hidden="true"></i></a>Integer handle vs IBinder token</h4>
<p>Sometimes MCIMMS needs to issue certain types of identifiers to the multi-client IME so that the IME can later specify to which entity or resource it intends to access. A good example is the IME client identifier. Multi-client IME definitely need to be able to specify which IME client to be interacted with for certain operations. The problem is that MCIMMS cannot simply pass <code>IInputMethodClient</code> to the multi-client IME as an ID because it would allow the IME to make IPC calls to the IME client. For this kind of situations, we usually use <code>Binder</code> object just as a non-spoofable token. For instance, IMMS creates another &apos;Binder&apos; token then pass it to the IME, instead of directly passing &apos;IWindow&apos; Binder token.</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InputMethodManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IInputMethodManager</span>.<span class="hljs-title">Stub</span>
        <span class="hljs-keyword">implements</span> <span class="hljs-title">ServiceConnection</span>, <span class="hljs-title">Handler</span>.<span class="hljs-title">Callback</span> </span>{
    ...
    <span class="hljs-meta">@GuardedBy</span>(<span class="hljs-string">&quot;mMethodMap&quot;</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakHashMap&lt;IBinder, IBinder&gt; mImeTargetWindowMap = <span class="hljs-keyword">new</span> WeakHashMap&lt;&gt;();

    ...

    <span class="hljs-meta">@GuardedBy</span>(<span class="hljs-string">&quot;mMethodMap&quot;</span>)
    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-function">InputBindResult <span class="hljs-title">attachNewInputLocked</span><span class="hljs-params">(@StartInputReason <span class="hljs-keyword">int</span> startInputReason, <span class="hljs-keyword">boolean</span> initial)</span> </span>{
        ...
        <span class="hljs-keyword">final</span> Binder startInputToken = <span class="hljs-keyword">new</span> Binder();
        <span class="hljs-keyword">final</span> StartInputInfo info = <span class="hljs-keyword">new</span> StartInputInfo(mCurToken, mCurId, startInputReason,
                !initial, mCurFocusedWindow, mCurAttribute, mCurFocusedWindowSoftInputMode,
                mCurSeq);
        mImeTargetWindowMap.put(startInputToken, mCurFocusedWindow);
        ...
    }

    ...

    <span class="hljs-meta">@BinderThread</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reportStartInput</span><span class="hljs-params">(IBinder token, IBinder startInputToken)</span> </span>{
        <span class="hljs-keyword">if</span> (!calledWithValidToken(token)) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">synchronized</span> (mMethodMap) {
            <span class="hljs-keyword">final</span> IBinder targetWindow = mImeTargetWindowMap.get(startInputToken);
            <span class="hljs-keyword">if</span> (targetWindow != <span class="hljs-keyword">null</span> &amp;&amp; mLastImeTargetWindow != targetWindow) {
                mWindowManagerInternal.updateInputMethodTargetWindow(token, targetWindow);
            }
            mLastImeTargetWindow = targetWindow;
        }
    }
</code></pre>
<p><a href="InputMethodManagerService.java">services/core/java/com/android/server/inputmethod/InputMethodManagerService.java</a></p>
<p>However, in MCIMMS, for certain cases we decided to use a simple integer token, which can be spoofable and can be messed up if integer overflow happens. This is because:</p>
<ul>
<li>It does not make much sense to worry about malicious multi-client IMEs, because it is guaranteed to be a pre-installed system component.</li>
<li>Integer token is expected to be a more lightweight that <code>Binder</code> token.</li>
<li>For that use case, integer overflow is unrealistic.</li>
<li>Strict user separation is still enforced. Multi-client IMEs are still not allowed to interact with other users&apos; resources by any means.</li>
</ul>
<p>Currently the following IDs are implemented as integer tokens:</p>
<ul>
<li>Client ID</li>
<li>Window Handle<ul>
<li>Note that each IME client has its own Window Handle mapping table. Window Handle is valid only within the associated IME client.</li>
</ul>
</li>
</ul>

<script>console.log("plugin-popup....");document.onclick = function(e){ e.target.tagName === "IMG" && window.open(e.target.src,e.target.src)}</script><style>img{cursor:pointer}</style>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="InputMethod.html" class="navigation navigation-prev " aria-label="Previous page: Input Method">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="permissions.html" class="navigation navigation-next " aria-label="Next page: Permissions">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Multi Client Ime","level":"1.2.1.13","depth":3,"next":{"title":"Permissions","level":"1.2.1.14","depth":3,"path":"coding/Andriod/permissions.md","ref":"coding/Andriod/permissions.md","articles":[]},"previous":{"title":"Input Method","level":"1.2.1.12","depth":3,"path":"coding/Andriod/InputMethod.md","ref":"coding/Andriod/InputMethod.md","articles":[]},"dir":"ltr"},"config":{"//":["这是多行注释：    anchor-navigation-ex 是","anchor-navigation-ex 是","click-reveal 本地使用ok，但是github在build pages时，不识别click-reveal","accordion 也是折叠代码段","anchor-navigation-ex 是"],"plugins":["anchor-navigation-ex","toggle-chapters","expandable-chapters-small","splitter","code","page-treeview","popup","-search","-lunr","sidebar-style","auto-scroll-table","click-reveal","accordion","pageview-count","search-pro"],"root":"./markdownsFiles","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"sidebar-style":{"author":"Kent","title":"《知行，行知》"},"tbfed-pagefooter":{"copyright":"Copyright &copy ershouche-FE 2019","modify_label":"文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"page-treeview":{"collapsed":false,"copyright":"Copyright © aleen42","minHeaderCount":"1","minHeaderDeep":"1"},"disqus":{"shortName":"gitbookuse"},"splitter":{},"search-pro":{},"accordion":{},"auto-scroll-table":{},"popup":{},"lunr":{"maxIndexSize":200000},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"click-reveal":{},"highlight":{},"anchor-navigation-ex":{"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showGoTop":true,"showLevel":true},"pageview-count":{},"expandable-chapters-small":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"toggle-chapters":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"bookname":"笔记","variables":{},"title":"Kent的博客","gitbook":"*"},"file":{"path":"coding/Andriod/multi-client-ime.md","mtime":"2023-07-16T06:49:32.995Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-08-30T18:20:49.746Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-toggle-chapters/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sidebar-style/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-auto-scroll-table/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-click-reveal/click_reveal.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-accordion/accordionSelector.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

